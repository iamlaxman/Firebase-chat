<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>Zero-Cost Chat Nepal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      position: fixed;
      width: 100%;
      background: #f3f4f6;
    }

    /* Prevent zoom and ensure proper viewport */
    input, textarea, select {
      font-size: 16px !important;
      -webkit-appearance: none;
      border-radius: 0;
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    /* Message animations */
    .message-appear {
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Typing indicator animation */
    .typing-dots {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #9ca3af;
      animation: typingDot 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typingDot {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Custom gradients */
    .bg-messenger-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .bg-message-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* Glass morphism effect */
    .glass {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Online indicator pulse */
    .online-pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    /* Chat container fixed layout */
    .chat-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      background: #f3f4f6;
    }

    .chat-header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      min-height: 70px;
      flex-shrink: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
      position: relative;
    }

    .chat-input-area {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      padding: 1rem;
      flex-shrink: 0;
      z-index: 10;
    }

    /* Message bubbles */
    .message-bubble {
      max-width: 280px;
      word-wrap: break-word;
      font-size: 15px;
      line-height: 1.4;
      border-radius: 18px;
      padding: 12px 16px;
      margin-bottom: 8px;
      position: relative;
    }

    .message-bubble.sent {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 6px;
    }

    .message-bubble.received {
      background: white;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      margin-right: auto;
      border-bottom-left-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Input styling */
    .message-input {
      font-size: 16px !important;
      border-radius: 25px;
      border: 2px solid #e5e7eb;
      padding: 12px 20px;
      padding-right: 60px;
      width: 100%;
      outline: none;
      transition: border-color 0.2s ease;
      background: #f9fafb;
    }

    .message-input:focus {
      border-color: #667eea;
      background: white;
    }

    .send-button {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .send-button:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: translateY(-50%) scale(1);
    }

    /* Responsive design */
    @media (max-width: 640px) {
      .message-bubble {
        max-width: 85%;
        font-size: 15px;
      }
      
      .chat-header {
        min-height: 60px;
      }
      
      .chat-input-area {
        padding: 12px;
      }
      
      .message-input {
        padding: 14px 18px;
        padding-right: 58px;
      }
    }

    /* Fix for back button issue */
    .hidden {
      display: none !important;
    }

    .show {
      display: flex !important;
    }

    /* User list styling */
    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      padding: 6px 12px;
      margin: 3px;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
    }

    .user-online-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      display: inline-block;
    }
  </style>
</head>
<body>

<!-- Home/Login Screen -->
<div id="homeScreen" class="min-h-screen flex items-center justify-center bg-messenger-gradient p-4">
  <div class="glass rounded-3xl p-8 w-full max-w-md shadow-2xl">
    <div class="text-center mb-8">
      <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
        <i class="fas fa-comments text-3xl text-indigo-600"></i>
      </div>
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Laxman Chat</h1>
      <p class="text-gray-600">Connect with people from Nepal</p>
    </div>
    
    <div class="space-y-4">
      <div class="relative">
        <input 
          id="usernameInput" 
          type="text" 
          placeholder="Enter your name" 
          class="w-full px-4 py-3 pl-12 rounded-2xl border-2 border-transparent focus:border-indigo-500 focus:outline-none transition-all duration-200 bg-white/80 text-base"
          maxlength="20"
        >
        <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>
      
      <button id="startChatBtn" class="w-full bg-message-gradient text-white font-semibold py-3 px-6 rounded-2xl hover:shadow-xl transition-all duration-300 transform hover:scale-105">
        <i class="fas fa-rocket mr-2"></i>
        Start Chatting
      </button>
    </div>
  </div>
</div>

<!-- Chat Container -->
<div id="chatContainer" class="chat-container hidden">
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="flex items-center justify-between p-4">
      <div class="flex items-center space-x-3">
        <button id="backBtn" class="p-2 hover:bg-gray-100 rounded-full transition-colors md:hidden">
          <i class="fas fa-arrow-left text-gray-600"></i>
        </button>
        <div class="w-10 h-10 bg-message-gradient rounded-full flex items-center justify-center shadow-lg">
          <i class="fas fa-comments text-white"></i>
        </div>
        <div>
          <h2 class="font-bold text-gray-800 text-lg">Laxman Chat Nepal</h2>
          <div id="activeUsersCount" class="text-sm text-gray-500 flex items-center">
            <div class="w-2 h-2 bg-green-500 rounded-full online-pulse mr-2"></div>
            <span id="userCount">0</span> users online
          </div>
        </div>
      </div>
      
      <button id="showUsersBtn" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <i class="fas fa-users text-gray-600"></i>
      </button>
    </div>
    
    <!-- Active Users List (Hidden by default) -->
    <div id="activeUsersList" class="hidden px-4 pb-3">
      <div class="bg-gray-50 rounded-2xl p-3">
        <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
          <i class="fas fa-users mr-2"></i>
          Active Users
        </h3>
        <div id="usersList" class="flex flex-wrap gap-1"></div>
      </div>
    </div>
  </div>

  <!-- Chat Messages -->
  <div id="chatMessages" class="chat-messages custom-scrollbar">
    <!-- Messages will be dynamically added here -->
  </div>

  <!-- Typing Indicator -->
  <div id="typingIndicator" class="hidden px-4 py-2 bg-white border-t border-gray-200">
    <div class="flex items-center space-x-2 text-gray-500 text-sm">
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
      <span id="typingText">Someone is typing...</span>
    </div>
  </div>

  <!-- Message Input Area -->
  <div class="chat-input-area">
    <div class="relative">
      <input 
        type="text" 
        id="messageInput" 
        placeholder="Type a message..." 
        class="message-input"
        maxlength="500"
      >
      <button id="sendBtn" class="send-button" disabled>
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    <div class="text-xs text-gray-400 mt-2 text-right">
      <span id="charCount">0</span>/500
    </div>
  </div>
</div>

<!-- Firebase Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, set, push, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCCANSgKALzfeBWOvaCCbnYzzEL2n8Yj_8",
    authDomain: "fir-6d3d4.firebaseapp.com",
    databaseURL: "https://fir-6d3d4-default-rtdb.firebaseio.com",
    projectId: "fir-6d3d4",
    storageBucket: "fir-6d3d4.appspot.com",
    messagingSenderId: "34601518464",
    appId: "1:34601518464:web:14f60f012e99f349142d65"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentUser = null;
  let typingTimeout;
  let activeUsers = {};
  let typingUsers = {};

  // DOM elements
  const homeScreen = document.getElementById('homeScreen');
  const chatScreen = document.getElementById('chatContainer');
  const usernameInput = document.getElementById('usernameInput');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const charCount = document.getElementById('charCount');
  const backBtn = document.getElementById('backBtn');

  // Event listeners
  document.getElementById('startChatBtn').addEventListener('click', startChat);
  document.getElementById('showUsersBtn').addEventListener('click', toggleUsersList);
  backBtn.addEventListener('click', goBack);
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', handleMessageInput);
  messageInput.addEventListener('input', updateCharCount);
  usernameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') startChat();
  });

  // Prevent zoom on iOS
  document.addEventListener('gesturestart', function (e) {
    e.preventDefault();
  });

  function startChat() {
    const name = usernameInput.value.trim();
    if (!name) {
      usernameInput.focus();
      usernameInput.classList.add('border-red-500');
      setTimeout(() => usernameInput.classList.remove('border-red-500'), 2000);
      return;
    }
    
    currentUser = name;
    homeScreen.classList.add('hidden');
    chatScreen.classList.remove('hidden');
    chatScreen.classList.add('show');
    joinChat();
    
    // Focus message input after a small delay
    setTimeout(() => {
      messageInput.focus();
    }, 300);
  }

  function goBack() {
    if (currentUser) {
      // Clean up Firebase connections
      const userRef = ref(db, `activeUsers/${currentUser}`);
      const typingRef = ref(db, `typing/${currentUser}`);
      set(userRef, null);
      set(typingRef, null);
    }
    
    currentUser = null;
    chatScreen.classList.add('hidden');
    chatScreen.classList.remove('show');
    homeScreen.classList.remove('hidden');
    
    // Clear form
    usernameInput.value = '';
    messageInput.value = '';
    updateCharCount();
  }

  function joinChat() {
    // Set user as active
    const userRef = ref(db, `activeUsers/${currentUser}`);
    set(userRef, {
      name: currentUser,
      joinedAt: serverTimestamp(),
      status: 'online'
    });
    onDisconnect(userRef).remove();

    // Initialize typing status
    const typingRef = ref(db, `typing/${currentUser}`);
    set(typingRef, false);
    onDisconnect(typingRef).remove();

    // Listen for active users
    const usersRef = ref(db, 'activeUsers');
    onValue(usersRef, (snapshot) => {
      activeUsers = snapshot.val() || {};
      updateActiveUsers();
    });

    // Listen for messages
    const messagesRef = ref(db, 'messages');
    onValue(messagesRef, (snapshot) => {
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.innerHTML = '';
      const data = snapshot.val() || {};
      const sortedMessages = Object.entries(data)
        .map(([key, value]) => ({ ...value, id: key }))
        .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
      
      sortedMessages.forEach(msg => addMessage(msg));
      scrollToBottom();
    });

    // Listen for typing indicators
    const typingAllRef = ref(db, 'typing');
    onValue(typingAllRef, (snapshot) => {
      typingUsers = snapshot.val() || {};
      updateTypingIndicator();
    });
  }

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    const messageData = {
      user: currentUser,
      text: text,
      timestamp: Date.now(),
      id: Date.now() + Math.random()
    };

    push(ref(db, 'messages'), messageData);
    messageInput.value = '';
    updateCharCount();
    updateTyping(false);
  }

  function handleMessageInput(e) {
    updateTyping(true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => updateTyping(false), 2000);
    
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  function updateCharCount() {
    const count = messageInput.value.length;
    charCount.textContent = count;
    sendBtn.disabled = count === 0;
  }

  function updateTyping(status) {
    if (currentUser) {
      set(ref(db, `typing/${currentUser}`), status);
    }
  }

  function addMessage(msg) {
    const chatDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    const isCurrentUser = msg.user === currentUser;
    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.className = `message-appear mb-2`;
    
    messageDiv.innerHTML = `
      <div class="message-bubble ${isCurrentUser ? 'sent' : 'received'}">
        ${!isCurrentUser ? `<div class="text-xs font-semibold text-indigo-600 mb-1">${escapeHtml(msg.user)}</div>` : ''}
        <div class="leading-relaxed">${escapeHtml(msg.text)}</div>
        <div class="text-xs ${isCurrentUser ? 'text-white/70' : 'text-gray-500'} mt-1 text-right">
          ${time}
          ${isCurrentUser ? '<i class="fas fa-check ml-1"></i>' : ''}
        </div>
      </div>
    `;
    
    chatDiv.appendChild(messageDiv);
  }

  function updateActiveUsers() {
    const userCount = Object.keys(activeUsers).length;
    document.getElementById('userCount').textContent = userCount;
    
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';
    
    Object.entries(activeUsers).forEach(([username, userData]) => {
      const userBadge = document.createElement('div');
      userBadge.className = 'user-badge';
      userBadge.innerHTML = `
        <span class="user-online-dot"></span>
        <span>${escapeHtml(username)}</span>
      `;
      usersList.appendChild(userBadge);
    });
  }

  function updateTypingIndicator() {
    const typingUsersList = Object.entries(typingUsers)
      .filter(([user, isTyping]) => user !== currentUser && isTyping)
      .map(([user]) => user);
    
    const typingIndicator = document.getElementById('typingIndicator');
    const typingText = document.getElementById('typingText');
    
    if (typingUsersList.length > 0) {
      const text = typingUsersList.length === 1 
        ? `${typingUsersList[0]} is typing...`
        : `${typingUsersList.length} people are typing...`;
      typingText.textContent = text;
      typingIndicator.classList.remove('hidden');
    } else {
      typingIndicator.classList.add('hidden');
    }
  }

  function toggleUsersList() {
    const usersList = document.getElementById('activeUsersList');
    usersList.classList.toggle('hidden');
  }

  function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    setTimeout(() => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
  }

  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, (m) => map[m]);
  }

  // Initialize character counter
  updateCharCount();

  // Handle window resize and orientation changes
  window.addEventListener('resize', () => {
    setTimeout(scrollToBottom, 100);
  });

  window.addEventListener('orientationchange', () => {
    setTimeout(scrollToBottom, 300);
  });
</script>
</body>
</html>