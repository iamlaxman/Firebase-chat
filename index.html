<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>Laxman Poudel Chat Nepal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      position: fixed;
      width: 100%;
      background: #ffffff;
      -webkit-tap-highlight-color: transparent;
    }

    input, textarea, select {
      font-size: 16px !important;
      -webkit-appearance: none;
      border-radius: 0;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .message-appear {
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #9ca3af;
      animation: typingDot 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typingDot {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .bg-messenger-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .glass {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .online-pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    .chat-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      background: #ffffff;
    }

    .chat-header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      min-height: 56px;
      flex-shrink: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      background: #ffffff;
      position: relative;
    }

    .chat-input-area {
      position: sticky;
      bottom: 0;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 0.5rem;
      flex-shrink: 0;
      z-index: 10;
    }

    .message-bubble {
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.4;
      border-radius: 18px;
      padding: 10px 14px;
      margin-bottom: 8px;
      position: relative;
      touch-action: manipulation;
      transition: transform 0.2s ease;
    }

    .message-bubble.sent {
      background: #00c4b4;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message-bubble.received {
      background: #f1f1f1;
      color: #000000;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .message-bubble.swiping {
      transform: translateX(-20px);
    }

    .message-input {
      font-size: 15px !important;
      border-radius: 20px;
      border: 1px solid #d1d1d6;
      padding: 10px 16px;
      padding-right: 48px;
      width: 100%;
      outline: none;
      transition: border-color 0.2s ease;
      background: #ffffff;
    }

    .message-input:focus {
      border-color: #00c4b4;
    }

    .send-button {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #00c4b4;
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .send-button:active {
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 2px 8px rgba(0, 196, 180, 0.3);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: translateY(-50%) scale(1);
    }

    @media (max-width: 640px) {
      .message-bubble {
        max-width: 80%;
        font-size: 14px;
      }
      
      .chat-header {
        min-height: 56px;
      }
      
      .chat-input-area {
        padding: 0.5rem;
      }
      
      .message-input {
        padding: 10px 16px;
        padding-right: 48px;
      }
    }

    .hidden {
      display: none !important;
    }

    .show {
      display: flex !important;
    }

    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f1f1f1;
      border-radius: 20px;
      padding: 6px 12px;
      margin: 3px;
      font-size: 13px;
      font-weight: 500;
      color: #000000;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .user-badge:active {
      background: #e5e7eb;
    }

    .user-online-dot {
      width: 8px;
      height: 8px;
      background: #34c759;
      border-radius: 50%;
      display: inline-block;
    }

    .message-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 4px;
      padding: 4px 8px;
      background: transparent;
      justify-content: flex-end;
    }

    .message-actions.sent {
      justify-content: flex-end;
    }

    .message-actions.received {
      justify-content: flex-start;
    }

    .action-icon {
      cursor: pointer;
      color: #00c4b4;
      font-size: 20px;
      padding: 6px;
      border-radius: 50%;
      transition: background 0.2s ease, color 0.2s ease;
      touch-action: manipulation;
    }

    .action-icon:active {
      background: #e6f3f2;
      color: #008f83;
    }

    .quoted-message {
      background: rgba(0,0,0,0.05);
      border-left: 4px solid #00c4b4;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 8px;
      font-size: 13px;
      color: #333;
    }

    .deleted-message {
      font-style: italic;
      color: #999;
    }

    .edit-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d1d6;
      border-radius: 8px;
      font-size: 14px;
    }

    .edited-label {
      font-size: 11px;
      color: #8e8e93;
      margin-left: 6px;
    }

    .reply-preview {
      background: #f1f1f1;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 0 12px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .reply-preview span {
      color: #333;
    }

    .reply-preview button {
      padding: 4px;
    }

    .reactions-container {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      font-size: 16px;
      flex-wrap: wrap;
    }

    .reaction {
      background: #e6f3f2;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .reaction-count {
      font-weight: 500;
    }

    .pinned-messages {
      background: #f1f1f1;
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 56px;
      z-index: 10;
      font-size: 13px;
      color: #333;
    }

    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #666;
      font-size: 14px;
      padding: 4px;
    }

    .password-toggle:hover {
      color: #333;
    }
  </style>
</head>
<body>

<!-- Home/Login Screen -->
<div id="homeScreen" class="min-h-screen flex items-center justify-center bg-messenger-gradient p-4">
  <div class="glass rounded-3xl p-6 w-full max-w-md shadow-2xl">
    <div class="text-center mb-6">
      <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
        <i class="fas fa-comments text-2xl text-indigo-600"></i>
      </div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">Laxman Poudel Chat Nepal</h1>
      <p class="text-gray-600 text-sm">Connect with people from Nepal</p>
    </div>
    
    <div class="space-y-3">
      <div id="nameWrapper" class="relative">
        <input 
          id="usernameInput" 
          type="text" 
          placeholder="Enter your name" 
          class="w-full px-4 py-2 pl-10 rounded-xl border-2 border-transparent focus:border-indigo-500 focus:outline-none transition-all duration-200 bg-white/80 text-sm"
          maxlength="20"
        >
        <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>
      <div class="relative">
        <input 
          id="emailInput" 
          type="email" 
          placeholder="Enter your email" 
          class="w-full px-4 py-2 pl-10 rounded-xl border-2 border-transparent focus:border-indigo-500 focus:outline-none transition-all duration-200 bg-white/80 text-sm"
        >
        <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>
      <div class="relative">
        <input 
          id="passwordInput" 
          type="password" 
          placeholder="Enter your password" 
          class="w-full px-4 py-2 pl-10 pr-12 rounded-xl border-2 border-transparent focus:border-indigo-500 focus:outline-none transition-all duration-200 bg-white/80 text-sm"
        >
        <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        <i id="passwordToggle" class="fas fa-eye password-toggle"></i>
      </div>
      
      <button id="authBtn" class="w-full bg-teal-500 text-white font-semibold py-2 px-6 rounded-xl hover:shadow-xl transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
        <i class="fas fa-rocket mr-2"></i>
        Sign Up
      </button>
      <p id="toggleAuth" class="text-center text-blue-500 cursor-pointer text-xs">Already have an account? Sign In</p>
      <button id="googleBtn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-xl hover:shadow-xl transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-sm">
        <i class="fab fa-google mr-2 text-red-500"></i>
        Sign in with Google
      </button>
      <p id="authMessage" class="text-center text-xs mt-3 hidden"></p>
    </div>
    <div class="text-center mt-6 text-gray-500 text-xs">
      Developed by Laxman Poudel<br>
      Email: ethical.laxman@gmail.com<br>
      Phone: +9779867844454
    </div>
  </div>
</div>

<!-- Chat Container -->
<div id="chatContainer" class="chat-container hidden">
  <div class="chat-header">
    <div class="flex items-center justify-between p-3">
      <div class="flex items-center space-x-2">
        <button id="backBtn" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
          <i class="fas fa-arrow-left text-gray-600"></i>
        </button>
        <div class="w-9 h-9 bg-teal-500 rounded-full flex items-center justify-center shadow-lg">
          <i class="fas fa-comments text-white"></i>
        </div>
        <div>
          <h2 class="font-bold text-gray-800 text-base">Laxman Poudel Chat Nepal</h2>
          <div id="activeUsersCount" class="text-xs text-gray-500 flex items-center">
            <div class="w-2 h-2 bg-green-500 rounded-full online-pulse mr-1"></div>
            <span id="userCount">0</span> users online
          </div>
        </div>
      </div>
      
      <div class="flex space-x-1">
        <button id="profileBtn" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
          <i class="fas fa-user-cog text-gray-600"></i>
        </button>
        <button id="showUsersBtn" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
          <i class="fas fa-users text-gray-600"></i>
        </button>
      </div>
    </div>
    
    <div id="activeUsersList" class="hidden px-3 pb-2">
      <div class="bg-gray-50 rounded-xl p-2">
        <h3 class="text-xs font-semibold text-gray-700 mb-1 flex items-center">
          <i class="fas fa-users mr-1"></i>
          Active Users
        </h3>
        <div id="usersList" class="flex flex-wrap gap-1"></div>
      </div>
    </div>
  </div>

  <div id="pinnedMessages" class="pinned-messages hidden"></div>
  <div id="chatMessages" class="chat-messages custom-scrollbar"></div>

  <div id="replyPreview" class="reply-preview hidden">
    <span>Replying to: <span id="replyText"></span></span>
    <button id="cancelReply" class="text-red-500"><i class="fas fa-times"></i></button>
  </div>

  <div id="typingIndicator" class="hidden px-3 py-1 bg-white border-t border-gray-200">
    <div class="flex items-center space-x-1 text-gray-500 text-xs">
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
      <span id="typingText">Someone is typing...</span>
    </div>
  </div>

  <div class="chat-input-area">
    <div class="relative">
      <input 
        type="text" 
        id="messageInput" 
        placeholder="Type a message..." 
        class="message-input"
        maxlength="500"
      >
      <button id="sendBtn" class="send-button" disabled>
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    <div class="text-xs text-gray-400 mt-1 text-right">
      <span id="charCount">0</span>/500
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-5 w-80 max-w-[90%]">
    <h3 class="font-bold text-base mb-3">Edit Profile</h3>
    <div class="relative mb-3">
      <input 
        id="newNameInput" 
        type="text" 
        placeholder="New name" 
        class="w-full px-4 py-2 pl-10 rounded-xl border-2 border-gray-200 focus:border-teal-500 focus:outline-none transition-all duration-200 text-sm"
      >
      <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
    </div>
    <div class="flex justify-end space-x-2">
      <button id="saveNameBtn" class="bg-teal-500 text-white py-2 px-5 rounded-xl hover:shadow-lg transition-all text-sm">
        Save
      </button>
      <button id="closeModalBtn" class="py-2 px-5 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 transition-all text-sm">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Edit Message Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-5 w-80 max-w-[90%]">
    <h3 class="font-bold text-base mb-3">Edit Message</h3>
    <input id="editInput" type="text" class="edit-input mb-3">
    <div class="flex justify-end space-x-2">
      <button id="saveEditBtn" class="bg-teal-500 text-white py-2 px-5 rounded-xl hover:shadow-lg transition-all text-sm">
        Save
      </button>
      <button id="closeEditBtn" class="py-2 px-5 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 transition-all text-sm">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Reaction Modal -->
<div id="reactionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-5 w-80 max-w-[90%]">
    <h3 class="font-bold text-base mb-3">Choose Reaction</h3>
    <div class="flex gap-3 justify-center mb-3">
      <button class="reaction-btn text-2xl" data-reaction="👍">👍</button>
      <button class="reaction-btn text-2xl" data-reaction="❤️">❤️</button>
      <button class="reaction-btn text-2xl" data-reaction="😂">😂</button>
    </div>
    <div class="flex justify-end">
      <button id="closeReactionModal" class="py-2 px-5 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 transition-all text-sm">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Firebase Script -->
<script type="module">
  // Import the functions you need from the SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, set, push, onValue, onDisconnect, serverTimestamp, get, update, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, updateProfile, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCoKAoarWlu8B6cnIw549hfg_UPe8YRSko",
    authDomain: "nepchat-aac9d.firebaseapp.com",
    databaseURL: "https://nepchat-aac9d-default-rtdb.firebaseio.com",
    projectId: "nepchat-aac9d",
    storageBucket: "nepchat-aac9d.firebasestorage.app",
    messagingSenderId: "179485804786",
    appId: "1:179485804786:web:3ec8a2fc563b08c682286b"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  let currentUser = null;
  let currentDisplayName = null;
  let currentUsername = null;
  let typingTimeout;
  let activeUsers = {};
  let typingUsers = {};
  let isSignUp = true;
  let replyToId = null;
  let editMessageId = null;
  let reactionMessageId = null;
  let touchStartX = 0;
  let touchEndX = 0;
  const EDIT_TIME_LIMIT = 5 * 60 * 1000; // 5 minutes

  // DOM elements
  const homeScreen = document.getElementById('homeScreen');
  const chatScreen = document.getElementById('chatContainer');
  const nameWrapper = document.getElementById('nameWrapper');
  const usernameInput = document.getElementById('usernameInput');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const passwordToggle = document.getElementById('passwordToggle');
  const authBtn = document.getElementById('authBtn');
  const toggleAuth = document.getElementById('toggleAuth');
  const googleBtn = document.getElementById('googleBtn');
  const authMessage = document.getElementById('authMessage');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const charCount = document.getElementById('charCount');
  const backBtn = document.getElementById('backBtn');
  const profileBtn = document.getElementById('profileBtn');
  const profileModal = document.getElementById('profileModal');
  const newNameInput = document.getElementById('newNameInput');
  const saveNameBtn = document.getElementById('saveNameBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const replyPreview = document.getElementById('replyPreview');
  const replyText = document.getElementById('replyText');
  const cancelReply = document.getElementById('cancelReply');
  const editModal = document.getElementById('editModal');
  const editInput = document.getElementById('editInput');
  const saveEditBtn = document.getElementById('saveEditBtn');
  const closeEditBtn = document.getElementById('closeEditBtn');
  const reactionModal = document.getElementById('reactionModal');
  const closeReactionModal = document.getElementById('closeReactionModal');
  const pinnedMessages = document.getElementById('pinnedMessages');

  // Password show/hide toggle
  passwordToggle.addEventListener('click', () => {
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      passwordToggle.classList.remove('fa-eye');
      passwordToggle.classList.add('fa-eye-slash');
    } else {
      passwordInput.type = 'password';
      passwordToggle.classList.remove('fa-eye-slash');
      passwordToggle.classList.add('fa-eye');
    }
  });

  // Event listeners
  authBtn.addEventListener('click', handleAuth);
  toggleAuth.addEventListener('click', toggleAuthMode);
  googleBtn.addEventListener('click', signInWithGoogle);
  document.getElementById('showUsersBtn').addEventListener('click', toggleUsersList);
  backBtn.addEventListener('click', goBack);
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', handleMessageInput);
  messageInput.addEventListener('input', updateCharCount);
  profileBtn.addEventListener('click', openProfileModal);
  closeModalBtn.addEventListener('click', () => profileModal.classList.add('hidden'));
  saveNameBtn.addEventListener('click', saveNewName);
  cancelReply.addEventListener('click', () => {
    replyToId = null;
    replyPreview.classList.add('hidden');
  });
  closeEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));
  saveEditBtn.addEventListener('click', saveEditedMessage);
  closeReactionModal.addEventListener('click', () => reactionModal.classList.add('hidden'));

  // Reaction button listener
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('reaction-btn')) {
      const reaction = e.target.dataset.reaction;
      addReaction(reactionMessageId, reaction);
      reactionModal.classList.add('hidden');
    }
  });

  // Prevent zoom on iOS
  document.addEventListener('gesturestart', (e) => e.preventDefault());
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  });

  function sanitizeUsername(username) {
    return username.replace(/[.#$[\]]/g, '_');
  }

  function toggleAuthMode() {
    isSignUp = !isSignUp;
    if (isSignUp) {
      nameWrapper.classList.remove('hidden');
      authBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i> Sign Up';
      toggleAuth.textContent = 'Already have an account? Sign In';
    } else {
      nameWrapper.classList.add('hidden');
      authBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i> Sign In';
      toggleAuth.textContent = 'New user? Sign Up';
    }
    authMessage.classList.add('hidden');
    authBtn.disabled = false;
  }

  async function handleAuth() {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !email.includes('@') || !email.includes('.')) {
      showAuthMessage('Please enter a valid email.', true);
      return;
    }

    if (!password || password.length < 6) {
      showAuthMessage('Password must be at least 6 characters.', true);
      return;
    }

    authBtn.disabled = true;
    authBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

    try {
      if (isSignUp) {
        const name = usernameInput.value.trim();
        if (!name) {
          showAuthMessage('Please enter your name.', true);
          return;
        }
        await signUp(name, email, password);
      } else {
        await signIn(email, password);
      }
    } catch (error) {
      showAuthMessage(`Error: ${error.message}`, true);
    } finally {
      authBtn.disabled = false;
      authBtn.innerHTML = isSignUp ? '<i class="fas fa-rocket mr-2"></i> Sign Up' : '<i class="fas fa-rocket mr-2"></i> Sign In';
    }
  }

  async function signUp(name, email, password) {
    const username = sanitizeUsername(email.split('@')[0]);
    const usernameRef = ref(db, `usernames/${username}`);
    
    const snap = await get(usernameRef);
    if (snap.exists()) {
      showAuthMessage('This email is already registered. Try signing in.', true);
      return;
    }

    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    await updateProfile(user, { displayName: name });
    await set(usernameRef, { uid: user.uid });
    await sendEmailVerification(user);
    showAuthMessage('Account created! Please verify your email.', false);
    await signOut(auth);
  }

  async function signIn(email, password) {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    if (!user.emailVerified) {
      showAuthMessage('Please verify your email first.', true);
      await signOut(auth);
    }
  }

  async function signInWithGoogle() {
    googleBtn.disabled = true;
    googleBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
    try {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const username = sanitizeUsername(user.email.split('@')[0]);
      const usernameRef = ref(db, `usernames/${username}`);

      const snap = await get(usernameRef);
      if (snap.exists() && snap.val().uid !== user.uid) {
        showAuthMessage('This email is already registered with another account.', true);
        await signOut(auth);
        return;
      }
      await set(usernameRef, { uid: user.uid });
    } catch (error) {
      showAuthMessage(`Error: ${error.message}`, true);
    } finally {
      googleBtn.disabled = false;
      googleBtn.innerHTML = '<i class="fab fa-google mr-2 text-red-500"></i> Sign in with Google';
    }
  }

  function showAuthMessage(message, isError) {
    authMessage.textContent = message;
    authMessage.classList.remove('hidden', 'text-red-500', 'text-green-500');
    authMessage.classList.add(isError ? 'text-red-500' : 'text-green-500');
    setTimeout(() => authMessage.classList.add('hidden'), 5000);
  }

  onAuthStateChanged(auth, (user) => {
    if (user && user.emailVerified) {
      currentUser = user;
      currentDisplayName = user.displayName || user.email.split('@')[0];
      currentUsername = sanitizeUsername(user.email.split('@')[0]);
      homeScreen.classList.add('hidden');
      chatScreen.classList.remove('hidden');
      chatScreen.classList.add('show');
      joinChat();
      setTimeout(() => messageInput.focus(), 300);
    } else {
      currentUser = null;
      currentDisplayName = null;
      currentUsername = null;
      homeScreen.classList.remove('hidden');
      chatScreen.classList.add('hidden');
      chatScreen.classList.remove('show');
      usernameInput.value = '';
      emailInput.value = '';
      passwordInput.value = '';
      authMessage.classList.add('hidden');
    }
  });

  function goBack() {
    if (currentUser) {
      const userRef = ref(db, `activeUsers/${currentUser.uid}`);
      const typingRef = ref(db, `typing/${currentUser.uid}`);
      set(userRef, null);
      set(typingRef, null);
    }
    signOut(auth).catch((error) => console.error('Sign out error:', error));
  }

  function joinChat() {
    const userRef = ref(db, `activeUsers/${currentUser.uid}`);
    set(userRef, {
      name: currentDisplayName,
      username: currentUsername,
      joinedAt: serverTimestamp(),
      status: 'online'
    });
    onDisconnect(userRef).remove();

    const typingRef = ref(db, `typing/${currentUser.uid}`);
    set(typingRef, false);
    onDisconnect(typingRef).remove();

    const usersRef = ref(db, 'activeUsers');
    onValue(usersRef, (snapshot) => {
      activeUsers = snapshot.val() || {};
      updateActiveUsers();
    });

    const messagesRef = ref(db, 'messages');
    onValue(messagesRef, (snapshot) => {
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.innerHTML = '';
      const data = snapshot.val() || {};
      const sortedMessages = Object.entries(data)
        .map(([key, value]) => ({ id: key, ...value }))
        .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
      sortedMessages.forEach(msg => addMessage(msg));
      scrollToBottom();
    });

    const typingAllRef = ref(db, 'typing');
    onValue(typingAllRef, (snapshot) => {
      typingUsers = snapshot.val() || {};
      updateTypingIndicator();
    });

    const pinnedRef = ref(db, 'pinnedMessages');
    onValue(pinnedRef, (snapshot) => {
      const pinned = snapshot.val() || {};
      const pinnedMessagesDiv = document.getElementById('pinnedMessages');
      pinnedMessagesDiv.innerHTML = '';
      if (Object.keys(pinned).length > 0) {
        pinnedMessagesDiv.classList.remove('hidden');
        Object.keys(pinned).forEach((messageId) => {
          get(ref(db, `messages/${messageId}`)).then((snap) => {
            const msg = snap.val();
            if (msg && !msg.deleted) {
              const pinDiv = document.createElement('div');
              pinDiv.className = 'pinned-message flex items-center justify-between';
              pinDiv.innerHTML = `
                <span><strong>${escapeHtml(msg.user)}</strong>: ${escapeHtml(msg.text.substring(0, 50))}...</span>
                <button onclick="unpinMessage('${messageId}')" class="text-red-500 text-xs"><i class="fas fa-times"></i></button>
              `;
              pinnedMessagesDiv.appendChild(pinDiv);
            }
          });
        });
      } else {
        pinnedMessagesDiv.classList.add('hidden');
      }
    });
  }

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    const messageData = {
      user: currentDisplayName,
      username: currentUsername,
      text: text,
      timestamp: Date.now(),
      replyTo: replyToId,
      deleted: false,
      edited: false
    };

    push(ref(db, 'messages'), messageData)
      .then(() => {
        messageInput.value = '';
        updateCharCount();
        updateTyping(false);
        replyToId = null;
        replyPreview.classList.add('hidden');
      })
      .catch((error) => {
        console.error('Error sending message:', error);
      });
  }

  function handleMessageInput(e) {
    updateTyping(true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => updateTyping(false), 2000);
    
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  function updateCharCount() {
    const count = messageInput.value.length;
    charCount.textContent = count;
    sendBtn.disabled = count === 0;
  }

  function updateTyping(status) {
    if (currentUser) {
      set(ref(db, `typing/${currentUser.uid}`), status);
    }
  }

  function markMessageAsViewed(messageId) {
    if (currentUser) {
      set(ref(db, `messages/${messageId}/views/${currentUser.uid}`), serverTimestamp());
    }
  }

  function addMessage(msg) {
    const chatDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    const isCurrentUser = msg.username === currentUsername;
    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.className = `message-appear mb-3 ${isCurrentUser ? 'text-right' : 'text-left'}`;
    messageDiv.dataset.id = msg.id;

    // Swipe to reply
    messageDiv.addEventListener('touchstart', handleTouchStart, false);
    messageDiv.addEventListener('touchmove', handleTouchMove, false);
    messageDiv.addEventListener('touchend', (e) => handleTouchEnd(e, msg.id, msg.text), false);
    
    let content = '';
    if (msg.deleted) {
      content = '<div class="deleted-message">This message was deleted</div>';
    } else {
      if (msg.replyTo) {
        get(ref(db, `messages/${msg.replyTo}`)).then((snap) => {
          const repliedMsg = snap.val();
          if (repliedMsg && !repliedMsg.deleted) {
            const quoteDiv = document.createElement('div');
            quoteDiv.className = 'quoted-message';
            quoteDiv.innerHTML = `<strong>${escapeHtml(repliedMsg.user)}</strong>: ${escapeHtml(repliedMsg.text.substring(0, 50))}${repliedMsg.text.length > 50 ? '...' : ''}`;
            messageDiv.querySelector('.message-content').insertAdjacentElement('afterbegin', quoteDiv);
          }
        });
      }
      content = `
        <div class="message-content">
          <div class="leading-relaxed">${parseMentions(escapeHtml(msg.text))}</div>
        </div>
      `;
    }

    let reactionsHtml = '';
    if (msg.reactions) {
      const reactionCounts = {};
      Object.entries(msg.reactions).forEach(([userId, reaction]) => {
        reactionCounts[reaction] = (reactionCounts[reaction] || 0) + 1;
      });
      reactionsHtml = `<div class="reactions-container ${isCurrentUser ? 'justify-end' : 'justify-start'}">`;
      Object.entries(reactionCounts).forEach(([reaction, count]) => {
        reactionsHtml += `<span class="reaction">${reaction} <span class="reaction-count">${count}</span></span>`;
      });
      reactionsHtml += `</div>`;
    }

    let readReceipt = '';
    if (msg.views && Object.keys(activeUsers).every(uid => msg.views[uid])) {
      readReceipt = '<i class="fas fa-check-double ml-1 text-teal-200"></i>';
    } else if (isCurrentUser) {
      readReceipt = '<i class="fas fa-check ml-1 text-teal-200"></i>';
    }

    messageDiv.innerHTML = `
      <div class="message-bubble ${isCurrentUser ? 'sent' : 'received'}">
        ${!isCurrentUser ? `<div class="text-xs font-semibold text-teal-600 mb-1">${escapeHtml(msg.user)} (@${escapeHtml(msg.username)})</div>` : ''}
        ${content}
        <div class="text-xs ${isCurrentUser ? 'text-white/80' : 'text-gray-500'} mt-1 text-right flex items-center justify-end">
          ${time}
          ${msg.edited ? '<span class="edited-label">Edited</span>' : ''}
          ${readReceipt}
        </div>
      </div>
      <div class="message-actions ${isCurrentUser ? 'sent' : 'received'}">
        <i class="fas fa-reply action-icon" onclick="replyToMessage('${msg.id}', '${escapeHtml(msg.text)}')"></i>
        ${isCurrentUser && !msg.deleted && (Date.now() - msg.timestamp < EDIT_TIME_LIMIT) ? `
          <i class="fas fa-edit action-icon" onclick="editMessage('${msg.id}', '${escapeHtml(msg.text)}', ${msg.timestamp})"></i>
          <i class="fas fa-trash action-icon" onclick="deleteMessage('${msg.id}')"></i>
        ` : ''}
        <i class="fas fa-face-smile action-icon" onclick="openReactionModal('${msg.id}')"></i>
        <i class="fas fa-thumbtack action-icon" onclick="pinMessage('${msg.id}')"></i>
      </div>
      ${reactionsHtml}
    `;
    
    chatDiv.appendChild(messageDiv);
    if (!isCurrentUser && !msg.views?.[currentUser.uid]) {
      markMessageAsViewed(msg.id);
    }
  }

  function parseMentions(text) {
    return text.replace(/@(\w+)/g, '<span class="text-teal-600 font-semibold">@$1</span>');
  }

  window.editMessage = function(id, text, timestamp) {
    if (Date.now() - timestamp > EDIT_TIME_LIMIT) {
      alert('Edit time limit exceeded (5 minutes).');
      return;
    }
    editMessageId = id;
    editInput.value = text;
    editModal.classList.remove('hidden');
  }

  function saveEditedMessage() {
    const newText = editInput.value.trim();
    if (!newText) return;

    update(ref(db, `messages/${editMessageId}`), { text: newText, edited: true })
      .then(() => {
        editModal.classList.add('hidden');
      });
  }

  window.deleteMessage = function(id) {
    if (confirm('Are you sure you want to delete this message?')) {
      update(ref(db, `messages/${id}`), { deleted: true, text: '' });
    }
  }

  window.replyToMessage = function(id, text) {
    replyToId = id;
    replyText.textContent = text.substring(0, 50) + (text.length > 50 ? '...' : '');
    replyPreview.classList.remove('hidden');
    messageInput.focus();
  }

  window.openReactionModal = function(id) {
    reactionMessageId = id;
    reactionModal.classList.remove('hidden');
  }

  function addReaction(messageId, reaction) {
    if (!currentUser) return;
    const reactionRef = ref(db, `messages/${messageId}/reactions/${currentUser.uid}`);
    set(reactionRef, reaction).catch((error) => {
      console.error('Error adding reaction:', error);
    });
  }

  window.pinMessage = function(id) {
    if (confirm('Pin this message?')) {
      set(ref(db, `pinnedMessages/${id}`), true);
    }
  }

  window.unpinMessage = function(id) {
    if (confirm('Unpin this message?')) {
      remove(ref(db, `pinnedMessages/${id}`));
    }
  }

  function handleTouchStart(e) {
    touchStartX = e.changedTouches[0].screenX;
    e.currentTarget.classList.add('swiping');
  }

  function handleTouchMove(e) {
    touchEndX = e.changedTouches[0].screenX;
  }

  function handleTouchEnd(e, messageId, text) {
    if (touchStartX - touchEndX > 50) { // Swipe left
      replyToMessage(messageId, text);
    }
    e.currentTarget.classList.remove('swiping');
    touchStartX = 0;
    touchEndX = 0;
  }

  function updateActiveUsers() {
    const userCount = Object.keys(activeUsers).length;
    document.getElementById('userCount').textContent = userCount;
    
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';
    
    Object.entries(activeUsers).forEach(([uid, userData]) => {
      const userBadge = document.createElement('div');
      userBadge.className = 'user-badge';
      userBadge.innerHTML = `
        <span class="user-online-dot"></span>
        <span>${escapeHtml(userData.name)} (@${escapeHtml(userData.username)})</span>
      `;
      userBadge.addEventListener('click', () => {
        messageInput.value += `@${userData.username} `;
        messageInput.focus();
      });
      usersList.appendChild(userBadge);
    });
  }

  function updateTypingIndicator() {
    const typingUsersList = Object.entries(typingUsers)
      .filter(([uid, isTyping]) => uid !== currentUser.uid && isTyping)
      .map(([uid]) => activeUsers[uid]?.name || 'Unknown');
    
    const typingIndicator = document.getElementById('typingIndicator');
    const typingText = document.getElementById('typingText');
    
    if (typingUsersList.length > 0) {
      const text = typingUsersList.length === 1 
        ? `${typingUsersList[0]} is typing...`
        : `${typingUsersList.join(', ')} are typing...`;
      typingText.textContent = text;
      typingIndicator.classList.remove('hidden');
    } else {
      typingIndicator.classList.add('hidden');
    }
  }

  function toggleUsersList() {
    const usersList = document.getElementById('activeUsersList');
    usersList.classList.toggle('hidden');
  }

  function openProfileModal() {
    newNameInput.value = currentDisplayName;
    profileModal.classList.remove('hidden');
  }

  async function saveNewName() {
    const newText = newNameInput.value.trim();
    if (!newText || newText === currentDisplayName) {
      profileModal.classList.add('hidden');
      return;
    }
    try {
      await updateProfile(auth.currentUser, { displayName: newText });
      currentDisplayName = newText;
      await set(ref(db, `activeUsers/${currentUser.uid}/name`), newText);
      profileModal.classList.add('hidden');
    } catch (error) {
      console.error('Error updating name:', error);
      showAuthMessage('Failed to update name.', true);
    }
  }

  function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    setTimeout(() => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
  }

  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, (m) => map[m]);
  }

  updateCharCount();

  window.addEventListener('resize', () => setTimeout(scrollToBottom, 100));
  window.addEventListener('orientationchange', () => setTimeout(scrollToBottom, 300));
</script>
</body>
</html>